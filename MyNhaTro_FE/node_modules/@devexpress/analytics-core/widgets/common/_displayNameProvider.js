/**
* DevExpress Analytics (widgets\common\_displayNameProvider.js)
* Version:  22.2.14
* Build date: Oct 28, 2024
* Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
* License: https://www.devexpress.com/Support/EULAs/universal.xml
*/
import * as $ from 'jquery';
import { OperandProperty } from '../criteria/operators/property';
import { FilterEditorSerializer } from '../filtereditor/helpers/_serializer';
import { criteriaForEach } from '../criteria/utils/criteriaEnumeration';
import { CriteriaOperatorStateMachine } from '../criteria/utils/criteriaOperatorStateMachine';
export class DisplayExpressionConverter {
    constructor(displayNameProvider) {
        this.displayNameProvider = displayNameProvider;
    }
    _replaceNames(path, expression, getDisplayExpression) {
        var def = $.Deferred();
        if (!expression)
            return def.resolve('').promise();
        try {
            var expressionCriteria = CriteriaOperatorStateMachine.parse(expression, true);
        }
        catch (e) {
            return def.reject().promise();
        }
        var requests = [];
        var result = [];
        var serializer = new FilterEditorSerializer();
        criteriaForEach(expressionCriteria, (operator, innerPath) => {
            if (operator instanceof OperandProperty) {
                var isContainsParentRelationshipTraversalOperator = operator.propertyName.indexOf('^.') === 0;
                var propertyName = isContainsParentRelationshipTraversalOperator ? operator.propertyName.substring(2) : operator.propertyName;
                propertyName = innerPath ? [innerPath, propertyName].join('.') : propertyName;
                var request = getDisplayExpression ? this.displayNameProvider.getDisplayNameByPath(path, propertyName) :
                    this.displayNameProvider.getRealName(path, propertyName);
                requests.push(request.done(data => {
                    var convertedName = isContainsParentRelationshipTraversalOperator ? '^.' + data : data;
                    convertedName = innerPath ? convertedName.split('.').slice(innerPath.split('.').length).join('.') : convertedName;
                    result.push({
                        operand: operator,
                        convertedName
                    });
                }));
            }
        });
        if (requests.length === 0) {
            def.resolve(expression);
        }
        else {
            var processedRequestsCount = 0;
            var onAlways = () => {
                if (++processedRequestsCount < requests.length)
                    return;
                var lines = expression.split('\n');
                for (var i = 0; i < lines.length; i++) {
                    var operands = result.filter((value) => value.operand.startPosition.line === i).sort((a, b) => {
                        return a.operand.startPosition.column - b.operand.startPosition.column;
                    });
                    for (var j = 0, delta = 0; j < operands.length; j++) {
                        var column = operands[j].operand.startPosition.column;
                        var propertyName = operands[j].operand.propertyName;
                        var deltaName = 0;
                        if (operands[j].operand.originalPropertyLength !== propertyName.length) {
                            deltaName = Math.max(0, operands[j].operand.originalPropertyLength - serializer.serialize(operands[j].operand, false).length);
                        }
                        var convertedName = operands[j].convertedName;
                        if (!propertyName || column < 0)
                            continue;
                        lines[i] = lines[i].substring(0, column + delta) + convertedName + lines[i].substring(column + propertyName.length + deltaName + delta);
                        delta += convertedName.length - propertyName.length - deltaName;
                    }
                }
                def.resolve(lines.join('\n'));
            };
            requests.forEach(r => r.always(onAlways));
        }
        return def.promise();
    }
    toDisplayExpression(path, expression) {
        return this._replaceNames(path, expression, true);
    }
    toRealExpression(path, expression) {
        return this._replaceNames(path, expression, false);
    }
}
